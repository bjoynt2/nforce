var nforce = require('../');
//var sfuser = process.env.SFUSER;
//var sfpass = process.env.SFPASS;
var sfuser = 'brian.joynt@fbu.com';
var sfpass = 'Production09';

//var query = 'SELECT Id, FirstName, LastName, Email FROM Lead LIMIT 10';
var query = 'SELECT Id, Name, Account.Name, stagename FROM Opportunity ORDER BY CreatedDate DESC LIMIT 10';
var result = [];
const stringify = require('csv-stringify')
var fs = require('fs');

var path = require('path');
var filename = path.basename('/Users/owner/desktop/opportunity.csv');
console.log(filename);

var org = nforce.createConnection({
  clientId: '3MVG9rFJvQRVOvk5nd6A4swCyck.4BFLnjFuASqNZmmxzpQSFWSTe6lWQxtF3L5soyVLfjV3yBKkjcePAsPzi',
  clientSecret: '9154137956044345875',
  redirectUri: 'http://localhost:3000/oauth/_callback'
});

org.authenticate({ username: sfuser, password: sfpass}, function(err, oauth) {
  if(err) {
    console.error('unable to authenticate to sfdc');
  } else {
    org.query({ query: query, oauth: oauth }, function(err, resp) {
      if(err) throw err;
      if(resp.records && resp.records.length) {
        //DEBUG console.log(resp.records);
        //build array from records
        resp.records.forEach(function(rec) {
          result.push(rec.get('id') + ',' + String(rec.get('name')).replace(/[&\/\\#,+()$~%.'":*?<>{}]/g,'') + ',' + rec.get('stagename') + ',' + rec.get('account').Name + '\n');
        });

        
        //add header to start of array
        result.unshift("id" + "," + "name" + "," + "stagename" + "," + "account" + '\n');
        
        stringify(result, function(err, output){
          console.log(output);
          fs.writeFile('/Users/owner/desktop/opportunity.csv', output, 'utf8', function(err) {
            if (err) {
              console.log('Some error occured - file either not saved or corrupted file saved.');
            } else {
              console.log('It\'s saved! ' + filename);
            }
          });

        });
    

      


      }
    });
  }
});
